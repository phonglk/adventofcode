const CHAR_WALL = '#';
const CHAR_PATH = '.';

const isValid = (char: string) => [CHAR_PATH, CHAR_WALL].indexOf(char) > -1;

class CharMap {
  public lines: Position[][] = []
  constructor(mazeString: string) {
    const lines = mazeString.split('\n').filter((line) => line.trim() !== '');
    for (let i = 0; i < lines.length; i++) {
      this.lines.push([])
      const line = lines[i]
      for (let j = 0; j < line.length; j++) {
        this.lines[i].push(new Position(this, [i, j], lines[i].charAt(j)))
      }
    }
  }

  each(fn: (position: Position) => void) {
    this.lines.forEach(line => {
      line.forEach(position => fn (position))
    })
  }
}

class Distance {
  constructor(public distance: number, public node: GNode) {}
  toString() { return `-${this.distance}-> ${this.node.toString()}`}
}

class GNode {
  public distances: Distance[] = [];
  constructor(public name: string, public position: Position) {}

  toString() {
    return `${this.name}: ${this.position.toString()}`
  }
}

class Graph {
  public nodes: GNode[] = [];
  
  // find all paths to every node
  public explore() {
    this.nodes.forEach(node => {
      this.exploreNode(node, node.position, 0, [])
    })
  }

  public exploreNode(node: GNode, position: Position, step = 0, pastSteps: Position[] = []) {
    if (!position.isPath) return
    if (node.position !== position) {
      const foundNode = this.nodes.find((node => node.position === position))
      if (foundNode) {
        node.distances.push(new Distance(step, foundNode))
        return
      }
    }
    const moves = ['up', 'down', 'left', 'right']
    moves.forEach(move => {
      const next = position[move] as Position
      if (next && pastSteps.indexOf(next) === -1) this.exploreNode(node, next, step + 1, pastSteps.concat(position))
    })
  }

  public getShortest() {
    const start = this.nodes.find(node => node.name === 'AA');
    const end = this.nodes.find(node => node.name === 'ZZ');

    const queue = [{ cost: 0, node: start, pastNodes: [] }]
    console.log(this.nodes.length)
    const costs: number[] = []
    while(queue.length > 0) {
      const { cost, node, pastNodes: prevPastNodes } = queue.shift()
      if (prevPastNodes.find(pnode => pnode.name === node.name)) continue;
      const pastNodes = prevPastNodes.concat(node)
      if (node === end) { costs.push(cost); continue }
      console.log(node.toString(), cost, pastNodes.map(node => node.toString()).join(' -> '))
      // console.log(node.toString(), cost, pastNodes.length)
      queue.push(...node.distances.map(({ node, distance }) => ({ node, cost: cost + distance, pastNodes })))
      const portalNode = this.nodes.find(pnode => pnode.name === node.name && pnode !== node)
      if (portalNode) {
        queue.push(
          ...portalNode.distances.map(({ node, distance }) => ({ node, cost: cost + distance + 1, pastNodes }))
        )
      }
    }
    return Math.min(...costs)
  }
}

class Position {
  constructor(private charMap: CharMap, private position: number[], public value: string) {}
  get i() { return this.position[0]}
  get j() { return this.position[1]}

  get isWall() { return this.value === CHAR_WALL }
  get isPath() { return this.value === CHAR_PATH }
  get isAZ() { return /\w/.test(this.value) }

  get up() { return this.charMap.lines[this.i - 1][this.j] }
  get down() { return this.charMap.lines[this.i + 1][this.j] }
  get left() { return this.charMap.lines[this.i][this.j - 1] }
  get right() { return this.charMap.lines[this.i][this.j + 1] }

  toString() {
    return `[${this.i},${this.j}]`
  }
}

function solveMaze(mazeString: string) {
  const charMap = new CharMap(mazeString)
  const graph = new Graph()

  charMap.each((pos) => {
    const addNode = (name) => graph.nodes.push(new GNode(name, pos));
    if (pos.isPath) {
      if (pos.up.isWall) {
        if (pos.left.isAZ) { addNode(pos.left.left.value + pos.left.value)
        } else if (pos.right.isAZ) { addNode(pos.right.value + pos.right.right.value) }
      } else if (pos.left.isWall) {
        if (pos.up.isAZ) { addNode(pos.up.up.value + pos.up.value)
        } else if (pos.down.isAZ) { addNode(pos.down.value + pos.down.down.value)}
      }
    }
  })

  graph.explore()

  graph.nodes.forEach(node => {
    console.log(node.toString())
    node.distances.forEach(dist => {
      console.log(`     ${dist}`)
    })
  })

  return graph.getShortest();
}


// console.log(solveMaze(`
//          A
//          A
//   #######.#########
//   #######.........#
//   #######.#######.#
//   #######.#######.#
//   #######.#######.#
//   #####  B    ###.#
// BC...##  C    ###.#
//   ##.##       ###.#
//   ##...DE  F  ###.#
//   #####    G  ###.#
//   #########.#####.#
// DE..#######...###.#
//   #.#########.###.#
// FG..#########.....#
//   ###########.#####
//              Z
//              Z
// `));

// console.log(solveMaze(`
//                    A               
//                    A               
//   #################.#############  
//   #.#...#...................#.#.#  
//   #.#.#.###.###.###.#########.#.#  
//   #.#.#.......#...#.....#.#.#...#  
//   #.#########.###.#####.#.#.###.#  
//   #.............#.#.....#.......#  
//   ###.###########.###.#####.#.#.#  
//   #.....#        A   C    #.#.#.#  
//   #######        S   P    #####.#  
//   #.#...#                 #......VT
//   #.#.#.#                 #.#####  
//   #...#.#               YN....#.#  
//   #.###.#                 #####.#  
// DI....#.#                 #.....#  
//   #####.#                 #.###.#  
// ZZ......#               QG....#..AS
//   ###.###                 #######  
// JO..#.#.#                 #.....#  
//   #.#.#.#                 ###.#.#  
//   #...#..DI             BU....#..LF
//   #####.#                 #.#####  
// YN......#               VT..#....QG
//   #.###.#                 #.###.#  
//   #.#...#                 #.....#  
//   ###.###    J L     J    #.#.###  
//   #.....#    O F     P    #.#...#  
//   #.###.#####.#.#####.#####.###.#  
//   #...#.#.#...#.....#.....#.#...#  
//   #.#####.###.###.#.#.#########.#  
//   #...#.#.....#...#.#.#.#.....#.#  
//   #.###.#####.###.###.#.#.#######  
//   #.#.........#...#.............#  
//   #########.###.###.#############  
//            B   J   C               
//            U   P   P               
// `));

console.log(solveMaze(`
                                     Q           I     B   S     J     P   J                                         
                                     I           P     B   L     M     Q   H                                         
  ###################################.###########.#####.###.#####.#####.###.#######################################  
  #.#...#.........#.#...#.#...#.....#...#.#.#.#.#...#.....#.......#.....#.........#...#.........#.#.....#...#.....#  
  #.#.###.###.###.#.###.#.###.#.#.#.#.###.#.#.#.#.#######.#.#.#.#.#.#.###.#.#####.#.#.#.#########.#.#####.###.###.#  
  #.........#.#.................#.#...#.....#.#.#.#...#...#.#.#.#.#.#...#.#...#.....#.#.............#.....#...#.#.#  
  ###############.###.#.###.###.###.###.#####.#.#.#.#####.#####.#.#.#########.#########.###.#####.#####.#.#.#.#.###  
  #.............#.#...#.#.....#.#.........#.#...#.....#.......#.#.#.......#.......#...#.#...#...#.#.#...#...#.#.#.#  
  #########.###.#######.#.#.#######.#####.#.#.#.#.#######.###.###.#####.#.#.###.###.###.#####.#####.#.###.#####.#.#  
  #.........#.........#.#.#.#...#...#.....#...#.#.#...#.#...#.#.#.#...#.#.#.#.#.#...#.#...#...#.......#.#.#...#.#.#  
  ###############.###.#######.#########.#.#.###.#.###.#.#.###.#.#.#.#.###.#.#.#####.#.#.###.###.#######.#####.#.#.#  
  #.#...#.#.#.....#.......#.....#.#...#.#.#.#.......#.#.....#.#...#.#.....#...#.#.#.#...#.#.....#.#.#.......#.#.#.#  
  #.#.###.#.#.#########.#######.#.#.###.###.###.#.#.#.###.###.###.#.###.###.#.#.#.#.#.###.#.#.#.#.#.#.#######.#.#.#  
  #...........#.........#.#.#...........#.....#.#.#.#.......#.#...#.#.#.#...#...............#.#.#.........#.......#  
  #######.#########.###.#.#.#######.#######.###.#.#.###.#.#######.#.#.###.#######.#######.#######.#########.#####.#  
  #.#...#.#...#.#.#.#.........#...#.......#...#.#.#.#.#.#...#.#...#.....#...#.....#...#.#.#...#.#.#.#.#.#.......#.#  
  #.#.#######.#.#.#####.###.#.###.#.#####.#.#####.#.#.#.#.###.#.#.#.###.#####.###.#.#.#.###.###.#.#.#.#.###.#.#####  
  #.#.......#.#.........#...#.........#.#.#.#.#...#...#.#...#...#.#.#...#.....#.#...#.#.#...#...#.......#.#.#.#.#.#  
  #.#.#.#.###.###.#.#.#.#####.#.#.#####.#.#.#.###########.#####.#.#.#######.###.#.#.###.###.#.###.#######.#.###.#.#  
  #.#.#.#...#.#.#.#.#.#.#.#...#.#.#.......#.#.#.#.#.#.#...#.....#.#...#...#.....#.#.#.#.....#.#...........#...#...#  
  #.#####.###.#.#########.#.###.#######.#.#.#.#.#.#.#.###.###.###.###.#.#####.#####.#.#####.#.###.###.###.#.###.#.#  
  #.#.........#.#.#.#.#...#.#.#.....#.#.#.#...#...#.......#...#.....#...#.#.......#.#.#.#.....#.....#...#.#.....#.#  
  #.#####.#####.#.#.#.#.#####.#######.###.#.#.#.#.###.###.###.###.###.###.#.#########.#.###.#####.#.#######.#######  
  #.#...#.#.#.#...#.....#.#.#.#.#.#.#.#.#.#.#...#.#.....#.#.#.#.....#.....#...#.........#.#.#.#.#.#.#.#.#...#...#.#  
  #.#.###.#.#.#.#######.#.#.#.#.#.#.#.#.#.###.###.#.#####.#.#####.#######.###.#.#.#.#####.#.#.#.#.###.#.###.#.#.#.#  
  #.#...........#...#.#.....#.#.#.........#...#...#.....#.#...#.#...#.....#.....#.#.#.#...#...#.....#...#.....#...#  
  #.#.###.#########.#.#.#####.#.###.#.###.###.#.#####.#####.###.#.#.#.#.###.#####.###.###.#.###.#####.#####.#######  
  #...#.#.....#.#...#.#.#.....#.#.#.#.#.....#.#...#.......#.......#.#.#...#.....#.#.........#.#.#.#.....#.#...#.#.#  
  ###.#.#######.#.###.#.#####.#.#.#######.#.###.###.#.#####.#########.###.#.#########.###.###.#.#.#.#####.#.###.#.#  
  #.#.#.......#.....#.#...#.#.....#.#.....#.#...#.#.#.#.......#...#.#...#.#.#.#.....#.#.#...#.#.......#.......#.#.#  
  #.#.#.#######.###.#.#.###.#.#####.###.#.#####.#.###.#.#####.#.#.#.#.#.###.#.###.#####.###.#.#.###.###.#.#####.#.#  
  #...#.#.#...#...#.#...#...#.#.#.......#...#.....#...#...#.....#...#.#.#.............#.#.#.#...#.#.#.#.#.....#...#  
  ###.#.#.###.#####.#.###.###.#.#########.#######.#.#######.#####.###.#########.#######.#.#.#.#.#.###.###.#######.#  
  #.......#.....#.#.#...#.#...#.#        J       Q E       P     W   J         M    #.....#...#.#.#...#.....#.....#  
  ###.#######.#.#.#.#.###.###.#.#        M       I A       Q     C   K         Q    ###.###.#####.#.#.###.#####.###  
  #...#.#.#...#.#.#.............#                                                   #...#.........#.#.............#  
  ###.#.#.###.###.###.#######.#.#                                                   #.#.#.#####.#####.###.###.#.###  
SF........#.......#.#...#.#...#.#                                                 YL..#...#...#.#...#...#.#.#.#.#..WC
  #.###.#########.#.###.#.#.#####                                                   #.###.#.#.#.#.#########.#.#.#.#  
  #.#.......#...#.....#...#.....#                                                   #.#...#.#...#.#.#.#.#.....#...#  
  #.#####.###.#.#.###.#.#######.#                                                   #.#.#.#.#####.#.#.#.#.#######.#  
  #.#...#.....#...#.......#......SL                                                 #.#.#.#.................#.#.#.#  
  #####.#########################                                                   #.#######################.#.###  
  #...................#...#...#.#                                                   #.#...................#.......#  
  ###.#.###.#####.###.#.#.###.#.#                                                   #####.###.###.#######.#.#.#.#.#  
YY..#.#.#.......#.#.....#...#....OB                                               VN..#.#.#.#.#.......#.....#.#.#.#  
  #.#.#######.###.#.#####.#####.#                                                   #.#.#.#.#####.###.###.#.#####.#  
  #.#...#.#...#.#.#.#.....#.#...#                                                   #.......#.....#.#.#.#.#.....#..HV
  #.#.#.#.###.#.###.#####.#.###.#                                                   #####.#######.#.###.###########  
  #...#...#.#...#.....#.........#                                                   #...#.#.#.......#.....#.#...#.#  
  #####.###.###############.#####                                                   #.#.###.#####.#.###.#.#.#.###.#  
  #.#.#.#.#...#...#.#.#...#.#...#                                                 SF..#.#.......#.#.#.#.#.#...#...#  
  #.#.###.#.###.###.#.#.#.#####.#                                                   #.#.###.#########.#.#.#.#.#.#.#  
  #.#...........#.#.#...#........HI                                                 #.#.....#...#...#...#.#.#.#.#..EA
  #.#.#####.#####.#.###.#####.#.#                                                   #######.#.###.#####.#.#.#.#.###  
YL..#...#...#...#.#.#.....#.#.#.#                                                   #.#...#.............#...#...#.#  
  #.#.###.###.###.#.###.###.#.###                                                   #.#.#########.###.#.###.#.###.#  
  #.....#.................#.....#                                                   #.#.....#...#...#.#.#...#.#...#  
  #####################.#####.###                                                   #.#.#.#.#.###########.#.###.#.#  
ZZ............#.......#...#.#...#                                                   #...#.#...#.#.#.#...#.#.#...#.#  
  #.#######.#.#.#####.#####.#####                                                   #.#.###.###.#.#.#.#########.#.#  
  #...#.#...#.....#.....#.....#.#                                                 EJ..#.#.....#.#...#.#.....#...#.#  
  #.###.#############.#####.###.#                                                   #########.#.###.#.###.###.#.#.#  
  #.......#.....#.#.#...#.....#..PD                                                 #.........................#.#..PD
  #.###.###.#.###.#.###.#.#.###.#                                                   #######################.#.#####  
MQ..#.#...#.#.#.#...#.....#.....#                                                   #...#.#.#.......#.....#.#.....#  
  ###.#######.#.#.###############                                                   #.###.#.#.#####.#.###.#########  
  #.......#...#.......#.........#                                                   #.#.#...#...#.....#...#...#...#  
  #.#.###.#.#.#.###.#.#.#.###.#.#                                                   #.#.###.###.###.#.#.#####.###.#  
OB..#.#.....#...#...#...#.#...#.#                                                 PT....#...#.....#.#.#.#...#...#..LH
  #########.#.###.###.#########.#                                                   #.#.#.#.#.#####.###.#.#.#.###.#  
  #.....#.#.#.#...#.......#.#.#..GJ                                                 #.#...#.......#...#...#.......#  
  ###.###.#################.#.###                                                   #.#####.#.#.###################  
  #...#.......#.#...#.#.#.......#                                                   #.#...#.#.#.#.#.........#.....#  
  #.#.#.#####.#.#.###.#.###.#####                                                   #.###.#######.#####.#.#.#.###.#  
  #.#.#.#...#.......#.#.#.#...#.#                                                   #...#...#.....#.#...#.#.#...#.#  
  #.#.#.#.#.###.#####.#.#.###.#.#                                                   #####.###.###.#.#.###.#.###.#.#  
DU..#.#...#.#.....#.........#...#                                                   #.......#.#...#.#...#.#.#...#..BC
  ###.#####.#.#######.#.#####.###                                                   ###.#.#.#####.#.###.###.#.#.#.#  
  #.#.......#.........#..........LH                                               YY....#.#...............#...#.#.#  
  #.#####.#.#.###.#####.#####.#.#                                                   #.#####.###.#.#################  
  #...#.#.#.#.#.#.#.#.......#.#.#                                                   #...#.....#.#.#...#.........#.#  
  #.#.#.#######.###.#.###.#######                                                   ###.#############.###.#####.#.#  
GJ..#...#.#.......#...#.#.#...#.#                                                 HV..#.#.#.#...#.....#...#...#.#.#  
  ###.###.#####.#.#####.#####.#.#                                                   #.###.#.###.#####.###.#.#.#.#.#  
  #...#.#...#...#.#.#.#...#.#...#                                                   #.......#.....#.#...#...#.#.#..EJ
  #.###.###.#####.#.#.###.#.#.#.#                                                   #.###.#####.###.#.#.#####.#.#.#  
  #...........................#..BB                                                 #...#.............#.......#...#  
  ###.###.#.#.#.#.#.#.###.#.###.#                                                   #.###.#######.#####.###.#.#.#.#  
  #...#...#.#.#.#.#.#...#.#...#.#                                                   #.#.#.#.#.#.....#.#...#.#.#.#.#  
  #.#.###.###########.#.#.###.###        J     B         I   D       P       F      #.#.#.#.#.###.###.#.#####.#.###  
  #.#...#.....#.#.#...#.#.#.#.#.#        H     C         P   U       A       K      #.#.....#.#...#.........#.#...#  
  #.#####.#.###.#.#####.#.#.###.#########.#####.#########.###.#######.#######.#############.#.#.#.#.###.###.#.#####  
  #...#...#.....#.......#...#.#.#.........#.....#.#.....#.#...#.....#.#...#...........#.....#...#.#...#.#...#.....#  
  #.#######.###.#########.###.#.#.###.###.###.###.#.###.#.#.###.#####.#.#.###.###.###.#####.###.#.#.###.###########  
  #.....#...#.#.....#.#.....#...#...#...#...#.....#...#...#.....#.#...#.#.#...#...#.#...#.....#.#.#.#.........#...#  
  #.#.###.###.###.###.#########.#.###.###.#####.###.#.#.###.###.#.###.#.#.#####.###.#.#####.#.#########.#####.#.###  
  #.#.#.......#...#.......#.......#.#...#.#.#.#.#.#.#.#.#...#.#.....#...#.#.#...#.#.#.....#.#.....#.#.......#.....#  
  ###.#.###.#.#######.###.#.###.###.###.###.#.#.#.#.#.#.#.###.###.###.###.#.###.#.#.#.#.#.#.#.#####.#.#.###.#.#.###  
  #...#...#.#...#.....#.......#.#.....#...#.....#...#.#.#.#.........#.#.....#...#.#.#.#.#.#.#.....#...#...#.#.#.#.#  
  #.#.###########.###########.#####.#.###.#.#######.###.#.###.#######.#.#######.#.#.#.#.#######.#.###.###.#.#.#.#.#  
  #.#.........#...#.#.........#...#.#.....#.#...#.#...#.#.#.#.....#.#.#...#.#.......#.#...#.....#...#.#...#.#.#...#  
  ###.#.#.###.#####.#.###.###.###.#.#.#####.#.#.#.#.#######.#.#.#.#.#####.#.#####.#####.#.###.#.#.###.#########.#.#  
  #...#.#.#.#.#.#.....#...#.#.#.....#.#.#.....#...#.....#.....#.#.....#...#...........#.#...#.#.#.#.#...#.......#.#  
  #.#.#####.###.#####.#.#.#.#######.###.###.#####.#.#############.#####.###.#.#.#.#####.#########.#.###.#########.#  
  #.#...#.#...........#.#.#.#.#...#.....#.....#.#.#.#.....#.#...#.#.......#.#.#.#.#...#.#...#.........#.......#...#  
  #.#.#.#.###########.#####.#.#.###.#.#########.#.#.#.#####.###.#.#.###.###.#######.#######.#.#.###.###.#####.###.#  
  #.#.#...#...#.........#.#.........#.....#.#.....#.#.#...#.#.#...#...#.#...................#.#.#...#...#.....#...#  
  ###.###.#.#####.#.#.###.#####.###.#######.###.#.#.###.#.#.#.#.###.###.#.#.###.###.###.#######.###.###.###.#####.#  
  #.....#.#.......#.#.#...#.#...#.......#...#...#.#.....#.#...#.#...#.#.#.#...#.#.....#.....#.#.#.#...#.#.......#.#  
  #.#####.#####.#.#######.#.#.#.###.#####.#######.#######.#.#.#.###.#.#####.#######.###.#####.###.#####.###.#.#.#.#  
  #.#.#.#.#.#...#.#.......#...#...#.........#.#.....#.....#.#.....#...#...#...#.#.....#.#.#...#.....#.#.#...#.#.#.#  
  #.#.#.#.#.#.###.###.#.###.#############.###.###.###.#.###.#######.#####.#.###.#########.#.#####.###.#####.###.#.#  
  #.....#.#...#...#...#.......#.............#...#.#...#...#.#.....#.#.....#...#.#.#.#.#...#...#.#.#.#.#.#.#...#.#.#  
  #.###.#.#######.###.###.###.#####.###########.#.###.#.###.###.#.#.#####.#.#.#.#.#.#.###.#.###.#.#.#.#.#.#.###.###  
  #...#.#...#.#...#...#.#.#.#...#...#.......#.#.....#.#.#.......#.#.......#.#.#.#.#.....#.#...#.#.......#.....#...#  
  #.#########.#########.###.#.###.#.#.#.#.###.#.#.###.###.###.###.###.#.#####.#.#.#.#####.#.###.#.#######.#####.###  
  #.....#.#.....................#.#.#.#.#.#.....#.#.....#.#...#.....#.#...#.#.....#.#...#...#.#.......#.#...#.....#  
  #.#.###.#.###.###.###.#.#########.###.#.###.###.###.#.#######.#######.###.#####.#.#.###.###.#.###.###.#.###.#####  
  #.#.....#.#.....#.#.#.#.#.............#.#...#.....#.#...#...#.......#.#.........................#.....#.#.......#  
  #.#.#####.#.###.#.#.#.#.#######.#.#####.###.#.#.###.#.#.#.#.###.#####.#####.###.#.#.###.#####.###.#.#.#######.#.#  
  #.#.....#.#.#...#.#...#.#.......#.....#...#.#.#.#...#.#.#.#.......#.....#.....#.#.#.#.......#...#.#.#.....#...#.#  
  #######################################.#######.#.#.#####.###########.#######.###################################  
                                         P       V P A     J           F       H                                     
                                         A       N T A     K           K       I                                     

`))